<!DOCTYPE html>
<html>
<head>
  <title>Leaflet Map with Search and Routing</title>
  <!-- Leaflet CSS and JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

  <!-- Leaflet Search Plugin -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <!-- Leaflet Routing Plugin -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js"></script>

  <style>
    #map {
      height: 500px; /* Adjust height as needed */
    }
  </style>
</head>
<body>
  <div id="map"></div>
<script>
  // Initialize the map with a default location (London)
  var map = L.map('map').setView([51.505, -0.09], 13);

  // Define blue and green icons for start and end points
  var blueIcon = L.icon({
    iconUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-icon.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png',
    shadowSize: [41, 41]
  });

  var greenIcon = L.icon({
    iconUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-icon-2x-green.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png',
    shadowSize: [41, 41]
  });

  // Add OpenStreetMap tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  // Add a search bar using Leaflet Geocoder
  var geocoder = L.Control.geocoder({
    defaultMarkGeocode: false
  }).on('markgeocode', function(e) {
    var bbox = e.geocode.bbox;
    var poly = L.polygon([
      [bbox.getSouthWest().lat, bbox.getSouthWest().lng],
      [bbox.getSouthWest().lat, bbox.getNorthEast().lng],
      [bbox.getNorthEast().lat, bbox.getNorthEast().lng],
      [bbox.getNorthEast().lat, bbox.getSouthWest().lng]
    ]);
    map.fitBounds(poly.getBounds());
    L.marker(e.geocode.center).addTo(map)
      .bindPopup(e.geocode.name)
      .openPopup();
  }).addTo(map);

  // Add a routing control for directions
  var control = L.Routing.control({
    waypoints: [
      L.latLng(51.505, -0.09), // Default starting point
      L.latLng(51.515, -0.1)  // Default ending point
    ],
    routeWhileDragging: true,
    geocoder: L.Control.Geocoder.nominatim(),
    createMarker: function(i, waypoint, n) {
      if (i === 0) {
        return L.marker(waypoint.latLng, { icon: blueIcon }).bindPopup('Start');
      } else if (i === n - 1) {
        return L.marker(waypoint.latLng, { icon: greenIcon }).bindPopup('End');
      } else {
        return L.marker(waypoint.latLng).bindPopup('Via Point');
      }
    }
  }).addTo(map);

  // Add a click event to dynamically select start and end points
  map.on('click', function(e) {
    var waypoints = control.getWaypoints();
    if (!waypoints[0] || !waypoints[0].latLng) {
      control.spliceWaypoints(0, 1, e.latlng); // Set as start point
    } else {
      control.spliceWaypoints(waypoints.length - 1, 1, e.latlng); // Set as end point
    }
  });

  // Add Geocoder to the map
  map.addControl(geocoder);
</script>

</body>
</html>
